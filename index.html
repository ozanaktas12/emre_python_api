<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATH UzaklÄ±k Hesaplama (BIST)</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="brand">ðŸ“ˆ ATH UzaklÄ±k Hesaplama</h1>
      <nav class="actions">
        <a class="action" href="/" aria-current="page">Tek Hisse</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <h2 class="panel-title">Veri KaynaÄŸÄ±: Twelve Data</h2>
      <p class="muted">Sembol ve borsa seÃ§in, <strong>Hesapla</strong> butonuna basÄ±n.</p>

      <div class="form-row">
        <label class="field">
          <span class="field-label">Sembol</span>
          <input id="symbol" placeholder="THYAO" aria-label="Sembol" />
        </label>

        <label class="field">
          <span class="field-label">Borsa</span>
          <select id="exchange" aria-label="Borsa">
            <option value="BIST" selected>BIST</option>
            <option value="NONE">â€” boÅŸ (US)</option>
          </select>
        </label>

        <button type="button" id="runBtn" class="btn btn-primary">Hesapla</button>
      </div>

      <p class="hint muted">Ã–rnek: <code>THYAO</code> + <code>BIST</code> veya <code>AAPL</code> + <code>NONE</code></p>
      <button type="button" id="pingBtn" class="btn" style="margin-top:8px">BaÄŸlantÄ±yÄ± test et</button>
    </section>

    <section class="results panel" id="out" aria-live="polite">
      <div class="placeholder muted">SonuÃ§lar burada gÃ¶rÃ¼necek.</div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p class="muted">Â© <span id="y"></span> BIST ATH â€¢ Kaynak: Twelve Data â€¢ Bu sayfa, arka planda <code>/metrics</code> endpointâ€™ini Ã§aÄŸÄ±rÄ±r.</p>
    </div>
  </footer>

  <script>
    // 8010â€™dan aÃ§arsan '' (aynÄ± origin), PyCharm 63342â€™den aÃ§arsan 8010â€™a gider
const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? 'http://127.0.0.1:8010'
  : '';
    const btn = document.getElementById('runBtn');
    const out = document.getElementById('out');
    const symbolInput = document.getElementById('symbol');
    const exchangeSel = document.getElementById('exchange');

    function escapeHtml(str) {
      return str.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }
    function renderLoading() {
      out.innerHTML = '<div class="loading"><span class="spinner"></span> YÃ¼kleniyor...</div>';
    }
    function renderError(msg) {
      out.innerHTML = '<div class="error">'+ escapeHtml(msg) +'</div>';
    }
    function renderData(data) {
      out.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h3 class="symbol">${data.symbol}</h3>
            <span class="source muted">Twelve Data</span>
          </div>
          <div class="metrics">
            <div class="metric"><span>Son KapanÄ±ÅŸ</span><b>${Number(data.last_close).toFixed(2)}</b></div>
            <div class="metric"><span>ATH</span><b>${Number(data.ath).toFixed(2)}</b></div>
            <div class="metric"><span>ATHâ€™a UzaklÄ±k</span><b>${Number(data.to_ath_pct).toFixed(2)}%</b></div>
            <div class="metric"><span>52 HaftalÄ±k Zirve</span><b>${Number(data.wk52_high).toFixed(2)}</b></div>
            <div class="metric"><span>52 Haftaya UzaklÄ±k</span><b>${Number(data.to_52w_pct).toFixed(2)}%</b></div>
          </div>
          <details class="raw"><summary>Ham JSON</summary><pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre></details>
        </div>
      `;
    }

    async function run() {
      const symbol = symbolInput.value.trim();
      const exchange = exchangeSel.value;
      if (!symbol) { renderError('LÃ¼tfen bir sembol gir.'); return; }
      renderLoading();
      try {
        const url = `${API_BASE}/metrics?symbol=${encodeURIComponent(symbol)}&exchange=${encodeURIComponent(exchange)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Ä°stek baÅŸarÄ±sÄ±z');
        renderData(data);
      } catch (e) {
        renderError(e.message);
      }
    }

    btn.addEventListener('click', run);
    symbolInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') run(); });
    document.getElementById('y').textContent = new Date().getFullYear();

    // Basit baÄŸlantÄ± testi
    const pingBtn = document.getElementById('pingBtn');
    pingBtn?.addEventListener('click', async () => {
      out.innerHTML = '<div class="loading"><span class="spinner"></span> /health...</div>';
      try {
        const r = await fetch(`${API_BASE}/health`);
        const j = await r.json();
        out.innerHTML = `<div class="card"><pre>${escapeHtml(JSON.stringify(j, null, 2))}</pre></div>`;
      } catch (e) {
        out.innerHTML = `<div class="error">BaÄŸlantÄ± hatasÄ±: ${escapeHtml(String(e))}</div>`;
      }
    });
  </script>
</body>
</html>